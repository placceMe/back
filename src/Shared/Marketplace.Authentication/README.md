# Marketplace.Authentication - Shared Authentication Library

## ?? ?????

**Marketplace.Authentication** - ?? shared ?????????? ??? ?????????????? ?? ?????????? ??????? ? ?????????????? ??????????? ????????????. ?????????? ?????????????? ?????????? JWT ????????, ??????? ? Redis ?? HttpOnly cookies.

## ?? ??????? ??????????

- ? **JWT Authentication** ? ???????????? ??????????
- ? **Redis Session Management** ??? ???????????????
- ? **HttpOnly Cookies** ??? ???????
- ? **??????????? ????????? ?????????? ?????**
- ? **Token Revocation** (blacklist ? Redis)
- ? **Multi-device sessions** ? ????????? ?????????
- ? **???????? ??????????** - ???? ????? ????

## ?? ?????? ???????????

### 1. ??????? ????????? ?? ??????

```xml
<ProjectReference Include="..\..\Shared\Marketplace.Authentication\Marketplace.Authentication.csproj" />
```

### 2. ???????????? ? appsettings.json

```json
{
  "Authentication": {
    "Jwt": {
      "SecretKey": "your-super-secret-key-that-is-at-least-32-characters-long",
      "Issuer": "Marketplace",
      "Audience": "MarketplaceClients",
      "AccessTokenExpiryMinutes": 15,
      "RefreshTokenExpiryDays": 7
    },
    "Redis": {
      "ConnectionString": "redis:6379",
      "KeyPrefix": "marketplace:auth:",
      "DefaultDatabaseIndex": 0
    },
    "Session": {
      "DefaultSessionDuration": "1.00:00:00",
      "RefreshThreshold": "00:30:00",
      "MaxConcurrentSessions": 5,
      "EnableSessionExtension": true,
      "SessionExtensionThreshold": "00:15:00"
    }
  }
}
```

### 3. ??????????? ? Program.cs

```csharp
using Marketplace.Authentication.Extensions;
using Marketplace.Authentication.Middleware;

var builder = WebApplication.CreateBuilder(args);

// ?? ???? ????? ??? ??????????? ????? ??????????????!
builder.Services.AddMarketplaceAuthentication(builder.Configuration, "service-name");

// CORS ??? ????????? cookies (???? ????????)
builder.Services.AddCors(options =>
{
    options.AddDefaultPolicy(builder =>
    {
        builder
            .WithOrigins("http://localhost:3000")
            .AllowAnyMethod()
            .AllowAnyHeader()
            .AllowCredentials(); // ??????? ??? HttpOnly cookies
    });
});

var app = builder.Build();

app.UseCors();
app.UseAuthentication();
app.UseMiddleware<SessionActivityMiddleware>(); // ??????????? ????????? ?????
app.UseAuthorization();

app.Run();
```

## ?? ???????????? ? ???????????

### ?????? ????????????

```csharp
using Microsoft.AspNetCore.Authorization;
using System.Security.Claims;

[ApiController]
[Route("api/[controller]")]
public class MyController : ControllerBase
{
    [HttpGet("public")]
    public IActionResult PublicEndpoint()
    {
        return Ok("???????? ????");
    }

    [HttpGet("protected")]
    [Authorize] // ??????????? ????????? JWT + ?????
    public IActionResult ProtectedEndpoint()
    {
        var userId = User.FindFirst(ClaimTypes.NameIdentifier)?.Value;
        var userEmail = User.FindFirst(ClaimTypes.Email)?.Value;
        var roles = User.FindAll(ClaimTypes.Role).Select(c => c.Value).ToList();
        
        return Ok(new { userId, userEmail, roles });
    }
}
```

### ????????? ???????????? ? ISessionManager

```csharp
using Marketplace.Authentication.Abstractions;

[ApiController]
public class AuthController : ControllerBase
{
    private readonly ISessionManager _sessionManager;

    public AuthController(ISessionManager sessionManager)
    {
        _sessionManager = sessionManager;
    }

    [HttpPost("login")]
    public async Task<IActionResult> Login([FromBody] LoginRequest request)
    {
        // ???? ?????? ????????? ???????????
        var user = await ValidateUserAsync(request.Email, request.Password);
        if (user == null)
            return Unauthorized();

        // ????????? ????? ????? shared library
        var sessionRequest = new CreateSessionRequest
        {
            UserId = user.Id,
            UserEmail = user.Email,
            UserName = user.Name,
            Roles = user.Roles,
            DeviceId = "web-browser",
            IpAddress = Request.HttpContext.Connection.RemoteIpAddress?.ToString() ?? "",
            UserAgent = Request.Headers.UserAgent.ToString(),
            SessionDuration = TimeSpan.FromHours(24)
        };

        var sessionToken = await _sessionManager.CreateSessionAsync(sessionRequest);

        // ???????????? HttpOnly cookie
        var cookieOptions = new CookieOptions
        {
            HttpOnly = true,
            Secure = Request.IsHttps,
            SameSite = SameSiteMode.Strict,
            Expires = sessionToken.AccessTokenExpiry,
            Path = "/"
        };
        Response.Cookies.Append("authToken", sessionToken.AccessToken, cookieOptions);

        return Ok(new { Success = true, Message = "????? ????????" });
    }

    [HttpPost("logout")]
    [Authorize]
    public async Task<IActionResult> Logout()
    {
        var sessionId = User.FindFirst("session_id")?.Value;
        if (!string.IsNullOrEmpty(sessionId))
        {
            await _sessionManager.InvalidateSessionAsync(sessionId);
        }

        Response.Cookies.Delete("authToken");
        return Ok(new { Success = true });
    }

    [HttpGet("sessions")]
    [Authorize]
    public async Task<IActionResult> GetMySessions()
    {
        var userIdClaim = User.FindFirst(ClaimTypes.NameIdentifier)?.Value;
        if (!Guid.TryParse(userIdClaim, out var userId))
            return BadRequest();

        var sessions = await _sessionManager.GetUserSessionsAsync(userId);
        return Ok(sessions);
    }
}
```

## ?? Frontend ??????????

### JavaScript/TypeScript

```javascript
// ????? - ????? ??????????? ???????????? ? HttpOnly cookie
async function login(email, password) {
    const response = await fetch('/api/auth/login', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        credentials: 'include', // ???????: ???????? cookies
        body: JSON.stringify({ email, password })
    });
    
    return response.json();
}

// ???????? ?????? - cookie ??????????? ???????????
async function getProtectedData() {
    const response = await fetch('/api/data/protected', {
        credentials: 'include' // ???????: ??????? cookies
    });
    
    return response.json();
}

// ??????
async function logout() {
    const response = await fetch('/api/auth/logout', {
        method: 'POST',
        credentials: 'include'
    });
    
    return response.json();
}
```

### React Hook ???????

```typescript
import { useState, useCallback } from 'react';

export const useAuth = () => {
    const [user, setUser] = useState(null);
    const [loading, setLoading] = useState(false);

    const login = useCallback(async (email: string, password: string) => {
        setLoading(true);
        try {
            const response = await fetch('/api/auth/login', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'include',
                body: JSON.stringify({ email, password })
            });

            if (response.ok) {
                const userData = await getCurrentUser();
                setUser(userData);
                return { success: true };
            }
        } catch (error) {
            console.error('Login failed:', error);
        } finally {
            setLoading(false);
        }
        return { success: false };
    }, []);

    const getCurrentUser = useCallback(async () => {
        try {
            const response = await fetch('/api/auth/me', {
                credentials: 'include'
            });
            
            if (response.ok) {
                return await response.json();
            }
        } catch (error) {
            console.error('Get user failed:', error);
        }
        return null;
    }, []);

    return { user, loading, login, getCurrentUser };
};
```

## ?? ????????????

### JWT ????????????

```json
{
  "Authentication": {
    "Jwt": {
      "SecretKey": "???????-32-???????-???-???????",
      "Issuer": "YourAppName",
      "Audience": "YourClients",
      "AccessTokenExpiryMinutes": 15,    // ???????? ?????? ??? ???????
      "RefreshTokenExpiryDays": 7,       // ?????? ?????? ??? ?????????
      "ValidateIssuer": true,
      "ValidateAudience": true,
      "ValidateLifetime": true,
      "ClockSkew": "00:00:00"           // ??? ??????? ?? ??????????? ????
    }
  }
}
```

### Redis ????????????

```json
{
  "Authentication": {
    "Redis": {
      "ConnectionString": "localhost:6379",
      "KeyPrefix": "myapp:auth:",       // ??????? ??? ??????
      "DefaultDatabaseIndex": 0         // ???? ????? Redis
    }
  }
}
```

### ????? ????????????

```json
{
  "Authentication": {
    "Session": {
      "DefaultSessionDuration": "1.00:00:00",      // 24 ??????
      "RefreshThreshold": "00:30:00",               // Refresh ?? 30 ?? ?? ??????????
      "MaxConcurrentSessions": 5,                   // ????. ?????????? ?????
      "EnableSessionExtension": true,               // ???????????????
      "SessionExtensionThreshold": "00:15:00"       // ????? ??? ???????????
    }
  }
}
```

## ??? API Reference

### ISessionManager Methods

```csharp
// ????????? ????? ?????
Task<SessionToken> CreateSessionAsync(CreateSessionRequest request);

// ????????? ????? ?? ??????
Task<SessionValidationResult> ValidateSessionAsync(string sessionToken);

// ????????? ????? ?? ID
Task<SessionValidationResult> ValidateSessionByIdAsync(string sessionId);

// ????????? refresh token
Task<SessionToken?> RefreshTokenAsync(string refreshToken);

// ??????????? ?????
Task<bool> InvalidateSessionAsync(string sessionId);

// ??????????? ???? ????? ???????????
Task<bool> InvalidateAllUserSessionsAsync(Guid userId);

// ????????? ???? ????? ???????????
Task<List<AuthSession>> GetUserSessionsAsync(Guid userId);

// ??????????? ?????? (blacklist)
Task<bool> RevokeTokenAsync(string token);

// ????????? ?? ????? ??????????
Task<bool> IsTokenRevokedAsync(string tokenId);

// ????????? ?????????? ?????
Task<bool> UpdateSessionActivityAsync(string sessionId);

// ???????? ?????????? ?????
Task CleanupExpiredSessionsAsync();
```

### Models

```csharp
public class CreateSessionRequest
{
    public Guid UserId { get; set; }
    public string UserEmail { get; set; }
    public string UserName { get; set; }
    public List<string> Roles { get; set; }
    public string DeviceId { get; set; } = "default";
    public string IpAddress { get; set; }
    public string UserAgent { get; set; }
    public TimeSpan SessionDuration { get; set; }
    public Dictionary<string, object>? Metadata { get; set; }
}

public class SessionToken
{
    public string AccessToken { get; set; }
    public string RefreshToken { get; set; }
    public DateTime AccessTokenExpiry { get; set; }
    public DateTime RefreshTokenExpiry { get; set; }
    public string SessionId { get; set; }
}

public class AuthSession
{
    public Guid Id { get; set; }
    public Guid UserId { get; set; }
    public string UserEmail { get; set; }
    public string UserName { get; set; }
    public List<string> Roles { get; set; }
    public string DeviceId { get; set; }
    public string IpAddress { get; set; }
    public string UserAgent { get; set; }
    public DateTime CreatedAt { get; set; }
    public DateTime LastActivity { get; set; }
    public DateTime ExpiresAt { get; set; }
    public bool IsActive { get; set; }
    public Dictionary<string, object> Metadata { get; set; }
}
```

## ?? ????????? ?? ??????????

?????????? ??????????? ????? ??????? ?????:

```
INFO: Created new session {SessionId} for user {UserId}
INFO: Invalidated session {SessionId}
INFO: Invalidated all sessions for user {UserId}
INFO: Cleaned up {ExpiredCount} expired sessions
WARN: JWT Authentication failed: {Error}
WARN: Failed to update session activity for {SessionId}
ERROR: Failed to create session for user {UserId}
```

## ?? Testing

### Unit Test ???????

```csharp
[Test]
public async Task CreateSession_ValidRequest_ReturnsSessionToken()
{
    // Arrange
    var sessionManager = GetSessionManager();
    var request = new CreateSessionRequest
    {
        UserId = Guid.NewGuid(),
        UserEmail = "test@example.com",
        UserName = "Test User",
        Roles = new List<string> { "User" }
    };

    // Act
    var result = await sessionManager.CreateSessionAsync(request);

    // Assert
    Assert.That(result.AccessToken, Is.Not.Empty);
    Assert.That(result.RefreshToken, Is.Not.Empty);
    Assert.That(result.SessionId, Is.Not.Empty);
}
```

### Integration Test ???????

```csharp
[Test]
public async Task Login_ValidCredentials_SetsCookie()
{
    // Arrange
    var client = _factory.CreateClient();
    var loginData = new { email = "test@example.com", password = "password" };

    // Act
    var response = await client.PostAsJsonAsync("/api/auth/login", loginData);

    // Assert
    Assert.That(response.StatusCode, Is.EqualTo(HttpStatusCode.OK));
    Assert.That(response.Headers.Any(h => h.Key == "Set-Cookie"), Is.True);
}
```

## ?? Performance Tips

### Redis ???????????

```json
{
  "Authentication": {
    "Session": {
      "MaxConcurrentSessions": 3,        // ???????? ??? ???????? ???'???
      "EnableSessionExtension": false    // ???????? ???? ?? ????????
    }
  }
}
```

### Cleanup Job

??????? background service ??? ????????:

```csharp
public class SessionCleanupService : BackgroundService
{
    private readonly ISessionManager _sessionManager;

    protected override async Task ExecuteAsync(CancellationToken stoppingToken)
    {
        while (!stoppingToken.IsCancellationRequested)
        {
            await _sessionManager.CleanupExpiredSessionsAsync(stoppingToken);
            await Task.Delay(TimeSpan.FromHours(1), stoppingToken);
        }
    }
}

// ? Program.cs
builder.Services.AddHostedService<SessionCleanupService>();
```

## ?? Security Best Practices

### 1. Secrets Management

```bash
# ?????????????? User Secrets ??? ????????
dotnet user-secrets set "Authentication:Jwt:SecretKey" "your-secret-key"

# ??? production ?????????????? Azure Key Vault ??? ??????? ???????
```

### 2. HTTPS Only

```csharp
var cookieOptions = new CookieOptions
{
    HttpOnly = true,
    Secure = true,        // ?????? HTTPS
    SameSite = SameSiteMode.Strict,
    Path = "/"
};
```

### 3. Rate Limiting

```csharp
// ??????? rate limiting ??? login endpoints
builder.Services.AddRateLimiter(options =>
{
    options.AddFixedWindowLimiter("auth", limiterOptions =>
    {
        limiterOptions.PermitLimit = 5;
        limiterOptions.Window = TimeSpan.FromMinutes(1);
    });
});
```

## ?? Troubleshooting

### ????????: Cookie ?? ???????????

**???????:**
```javascript
// ????????????? ?? credentials: 'include' ?????
fetch('/api/endpoint', {
    credentials: 'include'  // ? ?? ???????!
});
```

### ????????: CORS ???????

**???????:**
```csharp
builder.Services.AddCors(options =>
{
    options.AddDefaultPolicy(builder =>
    {
        builder
            .WithOrigins("http://localhost:3000") // ?????? ?????
            .AllowCredentials();                  // ????'??????
    });
});
```

### ????????: ????? ?? ????????????

**???????:**
????????? ??????????? ?? Redis:
```bash
# ???? ???????????
redis-cli ping
# ??? ????????? PONG
```

## ?? Mobile App Support

??? ????????? ??????????? ?????????????? Authorization header:

```csharp
// Mobile client
var client = new HttpClient();
client.DefaultRequestHeaders.Authorization = 
    new AuthenticationHeaderValue("Bearer", token);
```

Shared authentication library ??????????? ????????? ?????? ???????!

## ?? ??????!

????? ? ??? ? ???????, ???????????? ??????? ?????????????? ??? ????? ??????????????? ? ???? ????????????? ????? ?????? ????:

```csharp
builder.Services.AddMarketplaceAuthentication(builder.Configuration, "service-name");
```

### ????????:

? **HttpOnly cookies** ??? ???-???????  
? **Redis sessions** ??? ???????????????  
? **JWT tokens** ? ???????????? ??????????  
? **Token revocation** ????? blacklist  
? **Multi-device support** ? ?????????  
? **??????????? ????????? ??????????**  
? **???????? ??????????** ? ???? ???????  

?????????????? ? ?????????! ??