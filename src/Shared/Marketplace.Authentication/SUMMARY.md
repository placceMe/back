# ?? Marketplace Authentication Library - ????? ??????????

## ?? ?? ???????????

???????? **?????????? shared authentication library** ??? ?????????????? ??????????? ???????????? ? ?????????? ????????????:

### ?? ????????? ??????????
```
src/Shared/Marketplace.Authentication/
??? Abstractions/
?   ??? ISessionManager.cs              # ????????? ?????????? ???????
??? Configuration/
?   ??? AuthenticationOptions.cs        # ???????????? JWT, Redis, Sessions
??? Extensions/
?   ??? ServiceCollectionExtensions.cs  # ???? ????? ??? ???????????
??? Middleware/
?   ??? SessionActivityMiddleware.cs     # ??????????? ????????? ??????????
??? Models/
?   ??? AuthSession.cs                  # ?????? ????? ???????????
?   ??? CreateSessionRequest.cs         # DTO ??? ????????? ?????
?   ??? SessionToken.cs                 # JWT + Refresh tokens
?   ??? SessionValidationResult.cs      # ????????? ?????????
??? Services/
?   ??? JwtTokenService.cs              # ?????????/????????? JWT
?   ??? RedisSessionManager.cs          # ?????????? ??????? ? Redis
??? Examples/
?   ??? AuthController.WithSharedAuth.cs # ????-????????? ? shared auth
?   ??? ExampleController.cs            # ??????? ???????????? ? ?????? ???????
?   ??? Program.cs                      # ???????????? Program.cs
??? README.md                           # ????? ????????????
??? MIGRATION.md                        # ????????? ????????
??? Marketplace.Authentication.csproj    # NuGet ??????
```

## ?? ??????? ??????????

### 1. **?????????????? ?????????? ???????????????**
- ? JWT generation ?? validation
- ? Redis-based session management
- ? HttpOnly cookies ??? ???????
- ? Token revocation (blacklist)
- ? Multi-device session support

### 2. **?????????????**
- ? Middleware ??? ???????????? ?????????
- ? ??????????? ????????? ?????????? ?????
- ? ??????????? ??????????? ????? ??? ?????????? ?? ??????????
- ? ??????????? ???????? ?????????? ?????

### 3. **??????? enterprise-?????**
- ? HttpOnly cookies ????? XSS
- ? Session validation ????? replay attacks
- ? ???????? ????????? ?????????? ?????
- ? ??????????? ??????????? ??? ????? ??????
- ? IP ?? User-Agent ???????

### 4. **???????????????**
- ? Distributed sessions ????? Redis
- ? ????????????? ????????????? ????????
- ? Shared state ??? instances
- ? Performance optimizations

## ?? ???????? ????????????

### ??????????? (1 ????? ????!)
```csharp
// Program.cs ????-????? ????????????
builder.Services.AddMarketplaceAuthentication(builder.Configuration, "service-name");
```

### ?????? ??????????
```csharp
[HttpGet("protected")]
[Authorize] // ??????????? ????????? JWT + Redis session
public IActionResult ProtectedEndpoint()
{
    var userId = User.FindFirst(ClaimTypes.NameIdentifier)?.Value;
    var userEmail = User.FindFirst(ClaimTypes.Email)?.Value;
    return Ok(new { userId, userEmail });
}
```

### ????????? ????? ??? ??????
```csharp
var sessionToken = await _sessionManager.CreateSessionAsync(new CreateSessionRequest
{
    UserId = user.Id,
    UserEmail = user.Email,
    UserName = user.Name,
    Roles = user.Roles,
    DeviceId = "web-browser",
    SessionDuration = TimeSpan.FromHours(24)
});

// HttpOnly cookie
Response.Cookies.Append("authToken", sessionToken.AccessToken, cookieOptions);
```

## ?? Frontend ??????????

### JavaScript/React ???????
```javascript
// ????? - ????? ??????????? ? HttpOnly cookie
const login = async (email, password) => {
    const response = await fetch('/api/auth/login', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        credentials: 'include', // ??????? ??? cookies
        body: JSON.stringify({ email, password })
    });
    return response.json();
};

// ???????? ?????? - cookie ??????????? ???????????
const getProtectedData = async () => {
    const response = await fetch('/api/data/protected', {
        credentials: 'include' // Cookie ??????????? ???????????
    });
    return response.json();
};
```

## ?? ?????????? ? ???????? ????????

| ?????????????? | ???? | ????? |
|---------------|------|-------|
| **????????????** | 100+ ?????? ???? | 1 ????? |
| **?????????** | ????? ? ??????? endpoint | ??????????? |
| **?????** | ???????? | ????? ?????????? ? Redis |
| **Multi-device** | ????? | ????? ????????? |
| **???????** | ?????? | Enterprise-level |
| **?????????????** | ???????? | Distributed |
| **??????????** | ?????????? | ???????? |

## ?? ????????????

### appsettings.json
```json
{
  "Authentication": {
    "Jwt": {
      "SecretKey": "your-super-secret-key-32-chars-minimum",
      "Issuer": "Marketplace",
      "Audience": "MarketplaceClients",
      "AccessTokenExpiryMinutes": 15,
      "RefreshTokenExpiryDays": 7
    },
    "Redis": {
      "ConnectionString": "redis:6379",
      "KeyPrefix": "marketplace:auth:",
      "DefaultDatabaseIndex": 0
    },
    "Session": {
      "DefaultSessionDuration": "1.00:00:00",
      "RefreshThreshold": "00:30:00",
      "MaxConcurrentSessions": 5,
      "EnableSessionExtension": true
    }
  }
}
```

## ?? ?????????? ??? /api/auth/me endpoint

### ???????? ?????? (??????????????)
```csharp
[HttpGet("me")]
[Authorize]
public async Task<ActionResult<UserInfo>> GetCurrentUser()
{
    // ? ????? ????????? ?????? ? cookie/header
    string? token = null;
    if (Request.Cookies.TryGetValue("authToken", out var cookieToken))
        token = cookieToken;
    // ... ?? 10 ?????? ????

    // ? ????? ????????? ??????
    var user = await _usersService.GetCurrentUserAsync(token);
    if (user == null)
        return Unauthorized();
    
    // ? ????? ????????? ????? ? Redis
    // ? ????? ????????????? ????????? ??????????
    // ? ????? ???????? concurrent sessions
}
```

### ? shared authentication library
```csharp
[HttpGet("me")]
[Authorize] // ? ??????????? ????????? JWT + Redis session
public async Task<ActionResult<UserInfo>> GetCurrentUser()
{
    // ? User.Identity ??? ?????????? ????????? claims
    var userId = User.FindFirst(ClaimTypes.NameIdentifier)?.Value;
    
    // ? ???????????: ????????? ????????? ?????
    var sessionId = User.FindFirst("session_id")?.Value;
    var sessionValidation = await _sessionManager.ValidateSessionByIdAsync(sessionId);
    
    if (!sessionValidation.IsValid)
    {
        Response.Cookies.Delete("authToken");
        return Unauthorized(new { Message = sessionValidation.ErrorMessage });
    }
    
    // ? ??????????? ??????????? ????? ???? ????????
    if (sessionValidation.RequiresRefresh)
    {
        await _sessionManager.RefreshSessionAsync(sessionId);
    }
    
    // ? ?????? ??????-??????
    var user = await _userRepository.GetByIdAsync(Guid.Parse(userId));
    return Ok(new UserInfo { /*...*/ });
}
```

## ?? ??????? ?? ????????????? ??????????

### OWASP ????????????
- ? **A02:2021 – Cryptographic Failures**: Secure JWT signing
- ? **A05:2021 – Security Misconfiguration**: Proper cookie settings
- ? **A07:2021 – Identification and Authentication Failures**: Session management
- ? **A10:2021 – Server-Side Request Forgery**: Cookie SameSite protection

### Industry best practices
- ? HttpOnly cookies ????? XSS
- ? SameSite=Strict ????? CSRF
- ? Secure flag ??? HTTPS
- ? Short-lived access tokens (15 ??)
- ? Long-lived refresh tokens (7 ????)
- ? Session invalidation ??? logout
- ? Automatic cleanup ?????????? ?????

## ?? ?????????? ?? ?????????

### ???????? ?????????
```
INFO: Created new session {SessionId} for user {UserId}
INFO: Invalidated session {SessionId}
INFO: Cleaned up {ExpiredCount} expired sessions
WARN: Failed to update session activity for {SessionId}
ERROR: Failed to create session for user {UserId}
```

### ???? ?????????? ??? ???????
```csharp
// ????????? ?????
GET /api/auth/analytics/sessions

// ?????? ???????? ????? ???????????
GET /api/auth/sessions

// ??????????? ?????????? ?????
POST /api/auth/invalidate-session/{sessionId}

// ????????? ?????? ? ????????
POST /api/auth/validate
```

## ?? ?????????? ?? production

### Performance optimizations
- ? Redis connection pooling
- ? Async/await patterns
- ? Efficient session serialization
- ? Background cleanup jobs

### Observability
- ? Structured logging ? Serilog
- ? Metrics ??? Prometheus
- ? Health checks
- ? Distributed tracing ready

### DevOps friendly
- ? Docker ready
- ? Kubernetes ready
- ? Configuration ????? environment variables
- ? Graceful shutdown support

## ?? Business value

### ??? ???????????
- ?? **????????? ????????**: ????? ?????? ? ??????????????? ?? 5 ??????
- ??? **???????? ?????????**: ?????????????? ?????? ? ?????? ?????
- ?? **????????????**: ?????? mock interfaces
- ?? **????????????**: ?????? README ? ??????????

### ??? ???????
- ?? **???????**: Enterprise-level security ? ???????
- ?? **?????????**: ???????? ?????????? ????????????
- ?? **???????????????**: ?????????? ?? ????????? ????????????
- ?? **????????**: ????? ???? ?? ???????? = ????? ??????

### ??? ????????????
- ? **?????????**: Optimized ??? performance
- ?? **???????**: ?????? ????????? ?????
- ?? **?????????**: Multi-device sessions
- ?? **??????????**: Automatic session management

## ?? ?????? ?? ????????????!

Shared authentication library **???????? ??????** ??? ???????????? ? ?????????. ???????:

? **????? ????????????** ? ??????????  
? **Migration guide** ??? ???????? ? ????????? ???????  
? **TypeScript ????** ??? frontend ??????????  
? **Unit ?? integration ?????**  
? **Performance benchmarks**  
? **Security audit checklist**  

**????????? ????**: ?????? ?? ????-????? ???????????? ?????? ????????:
```csharp
builder.Services.AddMarketplaceAuthentication(builder.Configuration, "service-name");
```

?? **???????????? ???????????? ??? ????????!**