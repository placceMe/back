# ?? ??????? ??????????? ? OrdersService

## ?? ?????

OrdersService ????? ???????????? **?????????? JWT ??????????? ASP.NET Core** ??? ???????????? ??????? ???? ??????????. ??????? ???????? **role-based access control (RBAC)** ?? **resource ownership validation**.

## ?? ?? ?????????

### ? ?????? ?? ???????:
- **JWT Token Validation** - ??????????? ????????? ????? middleware
- **Cookie Support** - ????????? JWT ??????? ? HttpOnly cookies
- **Role-based Authorization** - ???????? ??????? ?? ?????? ?????
- **Resource Ownership Validation** - ??????????? ?????? ????????? ?????? ?? ?????? ?????????
- **Swagger Integration** - ???????????? API ? ????????????

### ?? ???????? ??????????:
```csharp
// Program.cs - ?????????? JWT ??????????? ASP.NET Core
builder.Services.AddAuthentication(JwtBearerDefaults.AuthenticationScheme)
.AddJwtBearer(options =>
{
    options.TokenValidationParameters = new TokenValidationParameters
    {
        ValidateIssuer = true,
        ValidateAudience = true,
        ValidateLifetime = true,
        ValidateIssuerSigningKey = true,
        ValidIssuer = jwtIssuer,
        ValidAudience = jwtAudience,
        IssuerSigningKey = new SymmetricSecurityKey(Encoding.UTF8.GetBytes(jwtSecretKey))
    };
    
    // ?? ????????? ??????? ? cookies
    options.Events = new JwtBearerEvents
    {
        OnMessageReceived = context =>
        {
            // ??????????? Authorization header, ????? cookies
            if (context.Request.Cookies.ContainsKey("authToken"))
            {
                context.Token = context.Request.Cookies["authToken"];
            }
            return Task.CompletedTask;
        }
    };
});
```

## ?? ????? ???????

### ?? ???????? ?????????
- `GET /Health` - ?????????? ????? ??????? (??? DevOps)

### ?? ???????????? ???????????
- `POST /api/orders` - ????????? ?????????? (?????? ??? ????)
- `GET /api/orders/my` - ??? ?????????? (??????? ????????)
- `GET /api/orders/{id}` - ????????? ?????????? (?????? ?????? ??? ?????)
- `GET /api/orders/user/{userId}` - ?????????? ??????????? (?????? ???? ??? ?????)
- `PUT /api/orders/{id}/confirm` - ????????????? (??????? ??? ?????)
- `PUT /api/orders/{id}/reject` - ?????????? (??????? ??? ?????)

### ?? ?????? ??????????????
- `GET /api/orders` - ??? ?????????? ? ???????
- `DELETE /api/orders/{id}` - ????????? ??????????

## ??? ????????? ???????

### 1. **JWT ?????????**
```csharp
[Authorize] // ??????????? ????????? JWT ????? ??????????? middleware
public class OrdersController : ControllerBase
{
    // ??? ?????? ??????????? ????????
}
```

### 2. **????????? ????????? ???????**
```csharp
// ?????????? ???? ????????? ?????? ?? ?????? ????????????
var currentUserId = User.FindFirst(ClaimTypes.NameIdentifier)?.Value;
if (order.UserId.ToString() != currentUserId && !userRoles.Contains("Admin"))
{
    return Forbid("?? ?????? ??????????? ?????? ???? ??????????");
}
```

### 3. **Role-based ?????????**
```csharp
[Authorize(Roles = "Admin")] // ?????? ??????????????
public async Task<ActionResult<IEnumerable<OrderResponse>>> GetAllOrders()
```

### 4. **????????? ??????? ?? ?????????**
```csharp
// ????????? ?? ?????????? ??????? ?????????? ??? ????
if (request.UserId != userGuid)
{
    return Forbid("?? ?????? ?????????? ?????????? ?????? ??? ????");
}
```

## ?? ??????? ???????

| ???????? | ????????? | ?????????? | ??????? ??????? | ????? |
|----------|-----------|------------|----------------|-------|
| `GET /Health` | ? | ? | ? | ? |
| `POST /api/orders` | ? | ? (?????? ??? ????) | ? | ? |
| `GET /api/orders/my` | ? | ? | ? | ? |
| `GET /api/orders/{id}` | ? | ? | ? | ? |
| `GET /api/orders/user/{userId}` | ? | ? | ? | ? |
| `GET /api/orders` | ? | ? | ? | ? |
| `PUT /api/orders/{id}/confirm` | ? | ? | ? | ? |
| `PUT /api/orders/{id}/reject` | ? | ? | ? | ? |
| `DELETE /api/orders/{id}` | ? | ? | ? | ? |

## ?? Frontend ??????????

### ??????? 1: ???????????? HttpOnly cookies (??????????????)
```javascript
// 1. ????? ??? ????????? ?????? (???????????? ? HttpOnly cookie)
const loginResponse = await fetch('/api/auth/login', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  credentials: 'include', // ??????? ??? cookies
  body: JSON.stringify({ email, password })
});

// 2. ????????? ????????? (cookie ??????????? ???????????)
const ordersResponse = await fetch('/api/orders/my', {
  credentials: 'include' // Cookie ??????????? ???????????
});
```

### ??????? 2: Authorization header
```javascript
// 1. ?????????? ?????? ? localStorage (???? ????????)
localStorage.setItem('authToken', token);

// 2. ???????? ????? header
const ordersResponse = await fetch('/api/orders/my', {
  headers: {
    'Authorization': `Bearer ${localStorage.getItem('authToken')}`
  }
});
```

### ??????? ??????? ???????????
```javascript
const handleApiResponse = async (response) => {
  if (response.status === 401) {
    // Unauthorized - redirect to login
    localStorage.clear();
    window.location.href = '/login';
    return null;
  } else if (response.status === 403) {
    // Forbidden - show error
    const error = await response.json();
    alert(error.detail || '??????????? ???? ??? ????????? ????????');
    return null;
  } else if (!response.ok) {
    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
  }
  
  return response.json();
};
```

## ?? ???? ???????

### 401 Unauthorized
**???????:**
- ????????? JWT ?????
- ???????? ??? ???????????? ?????
- ???????????? ?????? ??????

**?????????:**
```json
{
  "type": "https://tools.ietf.org/html/rfc7235#section-3.1",
  "title": "Unauthorized",
  "status": 401,
  "traceId": "..."
}
```

### 403 Forbidden
**???????:**
- ?????? ??????? ?? ????? ????????
- ??????????? ???? ??? ???????? (?? ?????)
- ?????? ???????? ?????????? ??? ?????? ???????????

**?????????:**
```json
{
  "type": "https://tools.ietf.org/html/rfc7231#section-6.5.3",
  "title": "Forbidden",
  "status": 403,
  "detail": "?? ?????? ??????????? ?????? ???? ??????????"
}
```

## ?? ???????????? ????????????

### appsettings.json
```json
{
  "Jwt": {
    "SecretKey": "your-super-secret-key-32-chars-minimum-for-jwt-signing",
    "Issuer": "Marketplace",
    "Audience": "MarketplaceClients"
  }
}
```

### Environment Variables ??? Production
```bash
# Docker ??? Kubernetes
JWT__SECRETKEY=your-production-secret-key-minimum-32-characters
JWT__ISSUER=YourMarketplace
JWT__AUDIENCE=YourClients
ALLOWED_ORIGINS=https://yourdomain.com,https://app.yourdomain.com
```

## ?? ?????????? ? Swagger

1. **????????? Swagger UI**: `http://localhost:5004/swagger`
2. **????????? "Authorize"** ? ????????? ??????? ????
3. **??????? JWT ?????** ? ???????: `Bearer your_jwt_token_here`
4. **???????? endpoints** - ??? ???????? ????????? ????? ????????

## ?? ???????? HTTP ???????

### ????????? ?????? (? UsersService)
```http
POST http://localhost:5002/api/auth/login
Content-Type: application/json

{
  "email": "user@example.com",
  "password": "password123"
}
```

### ???????????? ?????? ? OrdersService
```http
GET http://localhost:5004/api/orders/my
Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
```

### ????????? ??????????
```http
POST http://localhost:5004/api/orders
Authorization: Bearer your_jwt_token_here
Content-Type: application/json

{
  "userId": "user-id-from-jwt-token",
  "notes": "Test order",
  "deliveryAddress": "123 Test Street",
  "items": [
    {
      "productId": "123e4567-e89b-12d3-a456-426614174001",
      "quantity": 2,
      "price": 29.99
    }
  ]
}
```

## ?? ?????????? ?? ?????????

### ????????????? ?????????
```csharp
// ??????? ????????
_logger.LogInformation("?????????? {UserId} ??????? ?????????? {OrderId}", userId, orderId);

// ?????? ????????? ???????
_logger.LogWarning("?????????? {UserId} ??????????? ???????? ?????? ?? ?????? ?????????? {OrderId}", 
    currentUserId, requestedOrderId);

// ???????
_logger.LogError(ex, "??????? ??? ????????? ?????????? ??? ??????????? {UserId}", userId);
```

### ??????? ??????? ??? ???????????
- ????????? ??????????????? ??????? (401)
- ????????? ???????????? ????? ??????? (403)
- ??????? ?????????/????????? ?????????

## ?? ?????????? ? UsersService

OrdersService ?????? JWT ??????, ???????? UsersService. **?????????????, ??**:

1. **???????????????? ??? ????? ????????? ????** ??? ??????? JWT
2. **Issuer ?? Audience** ??????????? ? ???? ????????
3. **Claims ?????????** ??????? `ClaimTypes.NameIdentifier` (userId)
4. **Claims ?????????** ??????? `ClaimTypes.Role` ??? role-based ???????????

### ??????? JWT claims ?????????:
```json
{
  "sub": "user-id-guid",
  "email": "user@example.com",
  "role": "User",
  "iss": "Marketplace",
  "aud": "MarketplaceClients",
  "exp": 1234567890
}
```

## ?? ???????? ???? ??????????

### ?? ???????
- **?????????? ?????????** ASP.NET Core - ??????? ????????????
- **HttpOnly cookies** ????????? ??? XSS ????
- **JWT expiration** ??????????? ????????????
- **???????? ?????????** ??? audit trails

### ?? ???????? ????????
- **???? ???????** `[Authorize]` ??????? ???????? ??????
- **Automatic user context** ????? `User.FindFirst()`
- **Standard configuration** ? appsettings.json
- **Swagger integration** ??? ?????????? API

### ?? ?????????? ????????
- **Stateless authentication** - ????? ?????????????
- **Health checks** ??? ???????????
- **Structured logging** ??? ?????????
- **Standard error codes** ??? frontend ???????

## ? ??????? ??????????

- [x] ? ?????? JWT ??????????? ? ASP.NET Core
- [x] ? ??????????? Program.cs ? middleware
- [x] ? ?????? [Authorize] ????????
- [x] ? ??????????? ????????? ????????? ????????
- [x] ? ?????? role-based authorization
- [x] ? ???????? HTTP ?????
- [x] ? ?????? structured logging
- [x] ? ??????????? CORS ??? cookies
- [x] ? ??????????? Swagger ? JWT
- [x] ? ????????????? API endpoints

**OrdersService ????? ???????? ????????? ? ??????? ?? production ????????????!** ??

## ?? ???????? ?????

1. **??????????** - ????????? integration tests ? JWT ????????
2. **Frontend ??????????** - ??????? UI ??? ?????? ? ????????????
3. **????????????? ? UsersService** - ???????????? ? ?????????? JWT
4. **??????????** - ??????????? ???????? ??? ?????? ???????

??????? ??????????? ????? ?????????? **enterprise-level ???????** ?????????????? ?????????? ?? ??????? ????????? ASP.NET Core! ??