### OrdersService API Testing with JWT Authorization
### ??? ????????? ????? ?????????? JWT ?????? (???? health check)

@baseUrl = http://localhost:5004
@usersServiceUrl = http://localhost:5002

### ===== ????????? JWT ?????? =====

### 1. ???????? ????????? JWT ????? ? UsersService
POST {{usersServiceUrl}}/api/auth/login
Content-Type: application/json

{
  "email": "user@example.com",
  "password": "password123"
}

### 2. ????????? ????? ? ????????? ?? ??????? ?????
@authToken = eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMjNlNDU2Ny1lODliLTEyZDMtYTQ1Ni00MjY2MTQxNzQwMDAiLCJlbWFpbCI6InVzZXJAZXhhbXBsZS5jb20iLCJyb2xlIjoiVXNlciIsImlzcyI6Ik1hcmtldHBsYWNlIiwiYXVkIjoiTWFya2V0cGxhY2VDbGllbnRzIiwiZXhwIjoxNzM0NTY3ODkwfQ.SECRET_SIGNATURE

### ===== ???????? ????????? =====

### 3. Health Check (????????? ??????)
GET {{baseUrl}}/Health

### ===== ???????? ????????? =====

### 4. ???????? ?????????? (???????? ???????????)
# ?????????? ???? ?????????? ?????????? ?????? ??? ????
POST {{baseUrl}}/api/orders
Authorization: Bearer {{authToken}}
Content-Type: application/json

{
  "userId": "123e4567-e89b-12d3-a456-426614174000",
  "notes": "Test order with JWT authorization",
  "deliveryAddress": "123 Test Street, Test City",
  "items": [
    {
      "productId": "123e4567-e89b-12d3-a456-426614174001",
      "quantity": 2,
      "price": 29.99
    },
    {
      "productId": "123e4567-e89b-12d3-a456-426614174002",
      "quantity": 1,
      "price": 49.99
    }
  ]
}

### 5. ???????? ??? ?????????? (???????????? ????????)
# ??????????? ???????????? userId ? JWT ??????
GET {{baseUrl}}/api/orders/my
Authorization: Bearer {{authToken}}

### 6. ???????? ?????????? ?? ID (??????? ??? ?????)
GET {{baseUrl}}/api/orders/123e4567-e89b-12d3-a456-426614174000
Authorization: Bearer {{authToken}}

### 7. ???????? ?????????? ??????????? ??????????? (??????? ??? ?????)
# ????? ??????????? ?????? ???? ?????????? ??? ???? ???????????????
GET {{baseUrl}}/api/orders/user/123e4567-e89b-12d3-a456-426614174000
Authorization: Bearer {{authToken}}

### 8. ??????????? ?????????? (??????? ??? ?????)
PUT {{baseUrl}}/api/orders/123e4567-e89b-12d3-a456-426614174000/confirm
Authorization: Bearer {{authToken}}

### 9. ????????? ?????????? (??????? ??? ?????)
PUT {{baseUrl}}/api/orders/123e4567-e89b-12d3-a456-426614174000/reject
Authorization: Bearer {{authToken}}

### ===== ??????????????? ????????? =====

### 10. ???????? ??? ?????????? (?????? ??????????????)
# ???????? ???? "Admin" ? JWT claims
GET {{baseUrl}}/api/orders
Authorization: Bearer {{authToken}}

### 11. ???????? ?????????? (?????? ??????????????)
DELETE {{baseUrl}}/api/orders/123e4567-e89b-12d3-a456-426614174000
Authorization: Bearer {{authToken}}

### ===== ????? ??????? =====

### 12. ???? ??? ?????? (??? ????????? 401 Unauthorized)
GET {{baseUrl}}/api/orders/my

### 13. ???? ? ???????? ??????? (??? ????????? 401 Unauthorized)
GET {{baseUrl}}/api/orders/my
Authorization: Bearer invalid.jwt.token

### 14. ???? ? ???????????? ??????? (??? ????????? 401 Unauthorized)
GET {{baseUrl}}/api/orders/my
Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMjMiLCJleHAiOjE2MDAwMDAwMDB9.expired_signature

### 15. ???? ????????? ?????????? ??? ?????? ??????????? (??? ????????? 403 Forbidden)
POST {{baseUrl}}/api/orders
Authorization: Bearer {{authToken}}
Content-Type: application/json

{
  "userId": "different-user-id-than-in-jwt-token",
  "notes": "Trying to create order for someone else - SHOULD FAIL",
  "deliveryAddress": "Hacker Street",
  "items": []
}

### 16. ???? ??????? ?? ?????? ?????????? (??? ????????? 403 Forbidden)
GET {{baseUrl}}/api/orders/other-user-order-id
Authorization: Bearer {{authToken}}

### ===== ?????????? ? COOKIES (?????????????? ??????) =====

### 17. ???? UsersService ?????????? HttpOnly cookie ??? ??????
# ??????? Authorization header, ????? ??????????? ??????????? ????? cookie
GET {{baseUrl}}/api/orders/my
# Cookie: authToken=your_jwt_token_here (?????????????? ??????????? ?????????)

### ===== ???????? ?????????? =====

### ? ??????? ??????????? (200 OK):
# [
#   {
#     "id": "123e4567-e89b-12d3-a456-426614174000",
#     "userId": "123e4567-e89b-12d3-a456-426614174001",
#     "totalAmount": 129.97,
#     "status": "Pending",
#     "notes": "Test order with JWT authorization",
#     "deliveryAddress": "123 Test Street, Test City",
#     "createdAt": "2024-01-01T10:00:00Z",
#     "updatedAt": "2024-01-01T10:00:00Z",
#     "items": [
#       {
#         "id": "item-1",
#         "productId": "123e4567-e89b-12d3-a456-426614174001",
#         "quantity": 2,
#         "price": 29.99
#       }
#     ]
#   }
# ]

### ? ????? ?????? (401 Unauthorized):
# {
#   "type": "https://tools.ietf.org/html/rfc7235#section-3.1",
#   "title": "Unauthorized",
#   "status": 401,
#   "traceId": "0HMVF..."
# }

### ? ?????? ??????? ?? ?????? ?????????? (403 Forbidden):
# {
#   "type": "https://tools.ietf.org/html/rfc7231#section-6.5.3",
#   "title": "Forbidden", 
#   "status": 403,
#   "detail": "?? ?????? ??????????? ?????? ???? ??????????"
# }

### ? ??????????? ???? ??? ???????????????? ??????? (403 Forbidden):
# {
#   "type": "https://tools.ietf.org/html/rfc7231#section-6.5.3",
#   "title": "Forbidden",
#   "status": 403
# }

### ===== SWAGGER UI ?????????? =====

### ????????? Swagger UI: http://localhost:5004/swagger
### 1. ????????? ?????? "Authorize" ? ????????? ??????? ????
### 2. ???????: Bearer your_jwt_token_here
### 3. ????????? "Authorize"
### 4. ????? ??? protected endpoints ???????? ??? ??????????

### ===== FRONTEND INTEGRATION EXAMPLES =====

### JavaScript ? HttpOnly cookies (?????????????? ??????):
/*
// 1. ????? (????? ???????????? ? HttpOnly cookie ???????????)
const loginResponse = await fetch('/api/auth/login', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    credentials: 'include', // ??????? ??? cookies
    body: JSON.stringify({ email, password })
});

// 2. ???????????? OrdersService (cookie ??????????? ???????????)
const ordersResponse = await fetch('/api/orders/my', {
    credentials: 'include' // Cookie ??????????? ???????????
});

if (ordersResponse.ok) {
    const orders = await ordersResponse.json();
    console.log('My orders:', orders);
} else if (ordersResponse.status === 401) {
    // Redirect to login
    window.location.href = '/login';
} else if (ordersResponse.status === 403) {
    alert('??????????? ???? ??? ????????? ?????????');
}
*/

### JavaScript ? Authorization header:
/*
// 1. ????????? ?????? ? localStorage
const token = localStorage.getItem('authToken');

// 2. ???????????? ? ???????
const ordersResponse = await fetch('/api/orders/my', {
    headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
    }
});

// 3. ????????? ??????????
const createOrderResponse = await fetch('/api/orders', {
    method: 'POST',
    headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
    },
    body: JSON.stringify({
        userId: 'user-id-from-jwt-claims', // ???????: ??? ?????????? ? ???????
        notes: 'New order from frontend',
        deliveryAddress: 'User delivery address',
        items: [
            { productId: 'product-1', quantity: 2, price: 29.99 }
        ]
    })
});
*/

### ===== JWT TOKEN STRUCTURE EXAMPLE =====
### ????????? ????????? JWT claims ??? OrdersService:
/*
{
  "sub": "123e4567-e89b-12d3-a456-426614174000",    // User ID (ClaimTypes.NameIdentifier)
  "email": "user@example.com",                        // User email
  "role": "User",                                     // Role: "User", "Admin", etc. (ClaimTypes.Role)  
  "iss": "Marketplace",                               // Issuer (??? ?????????? ? appsettings)
  "aud": "MarketplaceClients",                        // Audience (??? ?????????? ? appsettings)
  "exp": 1234567890                                   // Expiration timestamp
}
*/

### ===== ???????????? =====

### ????????? ??????????? JWT ??????:
### 1. ????????? https://jwt.io/
### 2. ??????? ??? JWT ????? ? ???? "Encoded"
### 3. ????????? ????????? claims ? ??????? "Payload"
### 4. ????????????? ?? ?: sub, role, iss, aud, exp

### ???? OrdersService ??? ????????????:
### ??????? ? ????? ???????????? ????:
### - "?????????? {UserId} ??????? ?????????? {OrderId}"  
### - "?????????? {UserId} ??????????? ???????? ?????? ?? ?????? ??????????"
### - "?????? ???????? ?????????? ??? ????????? userId ? ??????"